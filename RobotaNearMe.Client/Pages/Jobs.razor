@page "/jobs"
@using RobotaNearMe.Lib.Modelos
@using RobotaNearMe.Client.Services
@inject AuthenticationStateProvider AuthenticationStateProvider


<div style="padding-top: 100px">
    <h5>Filter</h5>
    <label for="jobTypeFilter">Job Type:</label>
    <select @bind="_selectedJobType" class="form-control">
        <option value="">All</option>
        @foreach (JobType jobType in Enum.GetValues(typeof(JobType)))
        {
            <option value="@jobType">@jobType.ToString()</option>
        }
    </select>


    <label for="locationFilter">Location:</label>
    <select @bind="_selectedLocation" class="form-control">
        <option value=""> All</option>
        @foreach (LocationRegion region in Enum.GetValues(typeof(LocationRegion)))
        {
            <option value="@(region)">@region.ToString()</option>
        }
    </select>

    <button @onclick="OnFilter">Filter</button>

    @foreach (var item in _filteredJobOffers ?? _jobOffers)
    {
        <div> @item.Title </div>
        <div> @item.Language </div>
        <div> @item.Added </div>
        <button @onclick="(() => OnSelect(item))">More information</button>
    }
</div>

@inject ApiService _service
@inject NavigationManager NavigationManager
@code {
    private int _jobFieldId;
    private List<int> _jobFieldIds = new();
    private List<JobOffer> _jobOffers;
    private List<JobField> _jobFields;
    private JobType? _selectedJobType;
    private List<JobOffer> _filteredJobOffers;
    private LocationRegion? _selectedLocation;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        _jobOffers = _service.GetOffers().Where(x => x.StillValid == true).ToList();
        _jobFields = _service.GetJobFields().ToList();
        _filteredJobOffers = new List<JobOffer>();

    }
    private void OnSelect(JobOffer _selected)
    {
        NavigationManager.NavigateTo($"/jobdetails/{_selected.Id.ToString()}");
    }
    private void OnFilter()
    {
        _filteredJobOffers = new List<JobOffer>();
        foreach (var jobOffer in _jobOffers)
        {
            if (_selectedJobType.HasValue && _selectedJobType.Value == null && _selectedLocation == null)
            {
                _filteredJobOffers.Add(jobOffer);
            }
            // else if ((!_selectedJobType.HasValue && (!_selectedLocation.HasValue || _selectedLocation == jobOffer.LocationId)) || _selectedJobType.HasValue && _selectedJobType.Value == jobOffer.JobTypeId && _selectedLocation == null || !_selectedJobType.HasValue && _selectedLocation == jobOffer.LocationId || !_selectedJobType.HasValue && !_selectedLocation.HasValue || _selectedJobType.HasValue && _selectedJobType.Value == null && _selectedLocation == jobOffer.LocationId || _selectedJobType.Value == jobOffer.JobTypeId && _selectedLocation == jobOffer.LocationId)
            else if ((_selectedJobType == null || jobOffer.JobTypeId == _selectedJobType) && (_selectedLocation == null || jobOffer.LocationId == _selectedLocation))
            {
                _filteredJobOffers.Add(jobOffer);
            }
        }
    }

}
